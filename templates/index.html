<!DOCTYPE html>
<html>
<head>
<title>Barber Booking</title>
<link rel="stylesheet" href="/templates/style.css">

<style>
body{font-family:Arial;max-width:600px;margin:auto}
input,button,select{width:100%;padding:10px;margin:5px 0}
.card{border:1px solid #ccc;padding:10px;margin:10px 0}
.time-slot{display:inline-block;padding:10px 15px;margin:5px;border-radius:10px;background:#1e293b;color:white;cursor:pointer}
.time-slot.selected{background:#22c55e}
</style>
</head>

<body>

<h1>üíà –û–Ω–ª–∞–π–Ω –∑–∞–ø–∏—Å –¥–æ –±–∞—Ä–±–µ—Ä–∞</h1>

<!-- LOGIN -->
<h3>üîê –í—Ö—ñ–¥ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
<input type="password" id="adminPassword" placeholder="–ü–∞—Ä–æ–ª—å">
<button onclick="login()">–£–≤—ñ–π—Ç–∏</button>
<button onclick="logout()">–í–∏–π—Ç–∏</button>

<a href="/admin">üîê –ü–µ—Ä–µ–π—Ç–∏ –≤ –∞–¥–º—ñ–Ω–∫—É</a>
<hr>

<h2>–ù–æ–≤–∏–π –∑–∞–ø–∏—Å</h2>

<select id="service">
<option>–°—Ç—Ä–∏–∂–∫–∞</option>
<option>–ë–æ—Ä–æ–¥–∞</option>
<option>–°—Ç—Ä–∏–∂–∫–∞ + –ë–æ—Ä–æ–¥–∞</option>
</select>

<input id="name" placeholder="–í–∞—à–µ —ñ–º'—è">
<input id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">

<input id="date" type="date">
<h3>‚è∞ –í–∏–±–µ—Ä—ñ—Ç—å —á–∞—Å</h3>

<div id="messageBox" style="display:none"></div>

<h2>–°–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å—ñ–≤</h2>
<div id="list"></div>

<script>
let messageTimer=null;
let editingId=null;
let isAdmin=false;

////////////////////////////////////////////////
// –æ–±–º–µ–∂–µ–Ω–Ω—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è (30 –¥–Ω—ñ–≤ –≤–ø–µ—Ä–µ–¥)
////////////////////////////////////////////////
const today=new Date();
const maxDate=new Date();
maxDate.setDate(today.getDate()+30);

document.getElementById("date").min=today.toISOString().split("T")[0];
document.getElementById("date").max=maxDate.toISOString().split("T")[0];

////////////////////////////////////////////////
// –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
////////////////////////////////////////////////
function showMessage(text){
 const box=document.getElementById("messageBox");
 box.innerText=text;
 box.style.display="block";
 clearTimeout(messageTimer);
 messageTimer=setTimeout(()=>box.style.display="none",2000);
}

////////////////////////////////////////////////
// ADMIN CHECK
////////////////////////////////////////////////
async function checkAdmin(){
 const res=await fetch("/check-admin");
 const data=await res.json();
 isAdmin=data.admin;
 loadBookings();
}

////////////////////////////////////////////////
// —Ä–æ–±–æ—á—ñ –≥–æ–¥–∏–Ω–∏ –±–∞—Ä–±–µ—Ä–∞
////////////////////////////////////////////////
async function loadTimes(){
 const date=document.getElementById("date").value;
 if(!date) return;

 const day=new Date(date).getDay();
 const container=document.getElementById("timeSlots");
 container.innerHTML="";

 if(day===0){
   container.innerHTML="<p>–£ –Ω–µ–¥—ñ–ª—é –±–∞—Ä–±–µ—Ä –Ω–µ –ø—Ä–∞—Ü—é—î üò¥</p>";
   return;
 }

 const res=await fetch(`/available-times?date=${date}`);
 const times=await res.json();

 times.forEach(t=>{
   const div=document.createElement("div");
   div.className="time-slot";
   div.innerText=t;
   div.onclick=()=>selectTime(t,div);
   container.appendChild(div);
 });
}

function selectTime(time,el){
 document.querySelectorAll(".time-slot").forEach(x=>x.classList.remove("selected"));
 el.classList.add("selected");
 document.getElementById("selectedTime").value=time;
}

document.getElementById("date").addEventListener("change",loadTimes);

////////////////////////////////////////////////
// —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–ø–∏—Å—É
////////////////////////////////////////////////
async function createBooking(){
 const name=document.getElementById("name").value;
 const phone=document.getElementById("phone").value;
 const service=document.getElementById("service").value;
 const date=document.getElementById("date").value;
 const time=document.getElementById("selectedTime").value;

 if(!time){showMessage("–û–±–µ—Ä—ñ—Ç—å —á–∞—Å ‚è∞");return;}

 const datetime=date+"T"+time;

 const res=await fetch("/book",{
  method:"POST",
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({client_name:name,phone:phone,service:service,datetime:datetime})
 });

 const data=await res.json();
 if(!res.ok){showMessage(data.detail);return;}

 showMessage("–ó–∞–ø–∏—Å —Å—Ç–≤–æ—Ä–µ–Ω–æ ‚úÖ");
 loadTimes();
 loadBookings();
}

////////////////////////////////////////////////
// —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å—ñ–≤
////////////////////////////////////////////////
async function loadBookings(){
 const res=await fetch("/bookings");
 const data=await res.json();

 const list=document.getElementById("list");
 list.innerHTML="";

 data.forEach(b=>{
   const card=document.createElement("div");
   card.className="card";

   let adminButtons="";
   if(isAdmin){
     adminButtons=`<button onclick="deleteBooking(${b.id})">‚ùå –í–∏–¥–∞–ª–∏—Ç–∏</button>`;
   }

   card.innerHTML=`
     <b>${b.client_name}</b><br>
     ${b.service}<br>
     ${b.phone}<br>
     ${b.datetime}<br>
     ${adminButtons}
   `;
   list.appendChild(card);
 });
}

async function deleteBooking(id){
 await fetch(`/booking/${id}`,{method:"DELETE"});
 showMessage("–ó–∞–ø–∏—Å –≤–∏–¥–∞–ª–µ–Ω–æ");
 loadBookings();
 loadTimes();
}

////////////////////////////////////////////////
// login logout
////////////////////////////////////////////////
async function login(){
 const password=document.getElementById("adminPassword").value;
 const formData=new FormData();
 formData.append("password",password);

 const res=await fetch("/login",{method:"POST",body:formData,credentials:"include"});
 const data=await res.json();

 if(data.status==="ok"){showMessage("–ê–¥–º—ñ–Ω —É–≤—ñ–π—à–æ–≤ üîê");checkAdmin();}
 else showMessage("–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å ‚ùå");
}

async function logout(){
 await fetch("/logout",{credentials:"include"});
 showMessage("–í–∏ –≤–∏–π—à–ª–∏");
 checkAdmin();
}

////////////////////////////////////////////////
// —Å—Ç–∞—Ä—Ç —Å–∞–π—Ç—É
////////////////////////////////////////////////
checkAdmin();
</script>

</body>
</html>