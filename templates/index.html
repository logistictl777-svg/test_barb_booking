<!DOCTYPE html>
<html>
<head>
    <title>Barber Booking</title>
    <link rel="stylesheet" href="/templates/style.css">

    <style>
        body { font-family: Arial; max-width: 600px; margin: auto; }
        input, button, select { width:100%; padding:10px; margin:5px 0; }
        .card { border:1px solid #ccc; padding:10px; margin:10px 0; }
    </style>
</head>

<body>

<h1>üíà –û–Ω–ª–∞–π–Ω –∑–∞–ø–∏—Å –¥–æ –±–∞—Ä–±–µ—Ä–∞</h1>

<!-- üîê LOGIN -->
<div id="loginBox">
    <h3>üîê –í—Ö—ñ–¥ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
    <input type="password" id="adminPassword" placeholder="–ü–∞—Ä–æ–ª—å">
    <button onclick="login()">–£–≤—ñ–π—Ç–∏</button>
    <button onclick="logout()">–í–∏–π—Ç–∏</button>
</div>

<a href="/admin">üîê –ü–µ—Ä–µ–π—Ç–∏ –≤ –∞–¥–º—ñ–Ω–∫—É</a>
<hr>


<h2>–ù–æ–≤–∏–π –∑–∞–ø–∏—Å</h2>

<select id="service">
    <option>–°—Ç—Ä–∏–∂–∫–∞</option>
    <option>–ë–æ—Ä–æ–¥–∞</option>
    <option>–°—Ç—Ä–∏–∂–∫–∞ + –ë–æ—Ä–æ–¥–∞</option>
</select>

<input id="name" placeholder="–í–∞—à–µ —ñ–º'—è">
<input id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">

<input id="date" type="date">

<h3>‚è∞ –í–∏–±–µ—Ä—ñ—Ç—å —á–∞—Å</h3>
<div id="timeSlots"></div>
<input type="hidden" id="selectedTime">

<button onclick="createBooking()">–ó–∞–ø–∏—Å–∞—Ç–∏—Å—å</button>

<div id="messageBox" style="display:none" class="success-msg"></div>

<h2>–°–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å—ñ–≤</h2>
<div id="list"></div>

<script>
//////////////////////////////////////////////////////////
// –ì–õ–û–ë–ê–õ–¨–ù–Ü –ó–ú–Ü–ù–ù–Ü
//////////////////////////////////////////////////////////
let messageTimer = null;
let editingId = null;
let isAdmin = false;   // üëà –ù–û–í–ï

async function checkAdmin() {
    const res = await fetch("/check-admin");
    const data = await res.json();

    isAdmin = data.admin;   // ‚≠ê –ó–ë–ï–†–Ü–ì–ê–Ñ–ú–û –°–¢–ê–¢–£–°
    loadBookings();         // ‚≠ê –ü–ï–†–ï–ú–ê–õ–¨–û–í–£–Ñ–ú–û –°–ü–ò–°–û–ö
}
//////////////////////////////////////////////////////////
// –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø
//////////////////////////////////////////////////////////
function showMessage(text) {
    const box = document.getElementById("messageBox");
    box.innerText = text;
    box.style.display = "block";

    if (messageTimer) clearTimeout(messageTimer);
    messageTimer = setTimeout(() => box.style.display = "none", 2000);
}

//////////////////////////////////////////////////////////
// –ì–ï–ù–ï–†–ê–¶–Ü–Ø –í–Ü–õ–¨–ù–û–ì–û –ß–ê–°–£
//////////////////////////////////////////////////////////
async function generateTimeSlots() {
    const select = document.getElementById("datetime");
    select.innerHTML = "";

    const res = await fetch("/bookings");
    const bookings = await res.json();
    const busyTimes = bookings.map(b => b.datetime.slice(0,16));

    const selectedDate = document.getElementById("date").value;
    if (!selectedDate) return;

    for (let hour = 10; hour < 20; hour++) {
        for (let min of ["00","30"]) {
            const isoLocal = `${selectedDate}T${String(hour).padStart(2,"0")}:${min}`;
            if (busyTimes.includes(isoLocal)) continue;

            const option = document.createElement("option");
            option.value = isoLocal;
            option.text = `${hour}:${min}`;
            select.appendChild(option);
        }
    }
}

//////////////////////////////////////////////////////////
// –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –ó–ê–ü–ò–°–Ü–í
//////////////////////////////////////////////////////////
async function loadBookings() {
    const res = await fetch("/bookings");
    const data = await res.json();

    const list = document.getElementById("list");
    list.innerHTML = "";

    data.forEach(b => {
        const card = document.createElement("div");
        card.className = "card";

    let buttons = "";

let adminButtons = "";

if (isAdmin) {
    adminButtons = `
        <button onclick="editBooking(${b.id}, '${b.client_name}', '${b.phone}', '${b.service}', '${b.datetime}')">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
        <button onclick="deleteBooking(${b.id})">‚ùå –í–∏–¥–∞–ª–∏—Ç–∏</button>
    `;
}

card.innerHTML = `
    <b>${b.client_name}</b><br>
    ${b.service}<br>
    ${b.phone}<br>
    ${b.datetime}<br><br>
    ${adminButtons}
`;

        list.appendChild(card);
    });
}

//////////////////////////////////////////////////////////
// –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø
//////////////////////////////////////////////////////////
function editBooking(id, name, phone, service, datetime) {
    editingId = id;

    document.getElementById("name").value = name;
    document.getElementById("phone").value = phone;
    document.getElementById("service").value = service;
    document.getElementById("datetime").value = datetime.slice(0,16);

    showMessage("–†–µ–∂–∏–º —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è ‚úèÔ∏è");
}

//////////////////////////////////////////////////////////
// –°–¢–í–û–†–ï–ù–ù–Ø / –û–ù–û–í–õ–ï–ù–ù–Ø
//////////////////////////////////////////////////////////
async function createBooking() {
    const name = document.getElementById("name").value;
    const phone = document.getElementById("phone").value;
    const service = document.getElementById("service").value;
    
    const date = document.getElementById("date").value;
const time = document.getElementById("selectedTime").value;

if(!time){
    showMessage("–û–±–µ—Ä—ñ—Ç—å —á–∞—Å ‚è∞");
    return;
}

const datetime = date + "T" + time;

    let url = "/book";
    let method = "POST";

    if (editingId !== null) {
        url = `/booking/${editingId}`;
        method = "PUT";
    }

    const res = await fetch(url, {
        method: method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ client_name:name, phone:phone, service:service, datetime:datetime })
    });

    const data = await res.json();

    if (!res.ok) {
        showMessage(data.detail);
        return;
    }

    showMessage(editingId ? "–ó–∞–ø–∏—Å –æ–Ω–æ–≤–ª–µ–Ω–æ ‚úèÔ∏è" : "–ó–∞–ø–∏—Å —Å—Ç–≤–æ—Ä–µ–Ω–æ ‚úÖ");

    editingId = null;
    document.getElementById("name").value = "";
    document.getElementById("phone").value = "";

    generateTimeSlots();
    checkAdmin();   // üëà –∑–∞–º—ñ—Å—Ç—å loadBookings()
}

//////////////////////////////////////////////////////////
// –í–ò–î–ê–õ–ï–ù–ù–Ø
//////////////////////////////////////////////////////////
async function deleteBooking(id) {
    const res = await fetch(`/booking/${id}`, { method: "DELETE" });
    if (res.ok) {
        showMessage("–ó–∞–ø–∏—Å –≤–∏–¥–∞–ª–µ–Ω–æ üóëÔ∏è");
        loadBookings();
        generateTimeSlots();
    }
}

//////////////////////////////////////////////////////////
// LOGIN ADMIN
//////////////////////////////////////////////////////////
async function login() {
    const password = document.getElementById("adminPassword").value;
    const formData = new FormData();
    formData.append("password", password);

    const res = await fetch("/login", { method:"POST", body:formData });
    const data = await res.json();

    showMessage(data.status === "ok" ? "–í—Ö—ñ–¥ –≤–∏–∫–æ–Ω–∞–Ω–æ üîê" : "–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å ‚ùå");

 checkAdmin();
}
 async function logout() {
    await fetch("/logout");
    showMessage("–í–∏—Ö—ñ–¥ –≤–∏–∫–æ–Ω–∞–Ω–æ üëã");
    checkAdmin();   // üëà –í–ê–ñ–õ–ò–í–û
}
//////////////////////////////////////////////////////////
// –°–¢–ê–†–¢ –°–ê–ô–¢–£
//////////////////////////////////////////////////////////
document.getElementById("date").value = new Date().toISOString().split("T")[0];
document.getElementById("date").addEventListener("change", generateTimeSlots);

generateTimeSlots();
checkAdmin();   // üî• —Ç–µ–ø–µ—Ä –∑–∞–ø—É—Å–∫–∞—î–º–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É

// ===============================
// ‚è∞ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –≥–æ–¥–∏–Ω
// ===============================

// –∫–æ–ª–∏ –æ–±—Ä–∞–ª–∏ –¥–∞—Ç—É
// –∑–∞–ø—É—Å–∫–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è –ø–æ–≤–Ω–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏
window.addEventListener("DOMContentLoaded", () => {
    const dateInput = document.getElementById("date");
    if(dateInput){
        dateInput.addEventListener("change", loadTimes);
    }
});

async function loadTimes(){
    const date = document.getElementById("date").value;
    if(!date) return;

    const res = await fetch(`/available-times?date=${date}`);
    const times = await res.json();

    const container = document.getElementById("timeSlots");
    container.innerHTML = "";

    times.forEach(t=>{
        const div = document.createElement("div");
        div.className = "time-slot";
        div.innerText = t;
        div.onclick = () => selectTime(t, div);
        container.appendChild(div);
    });
}

function selectTime(time, el){
    document.querySelectorAll(".time-slot")
        .forEach(x=>x.classList.remove("selected"));

    el.classList.add("selected");
    document.getElementById("selectedTime").value = time;
}

</script>
<script>
async function login() {
    const password = document.getElementById("adminPassword").value;

    const formData = new FormData();
    formData.append("password", password);

    const res = await fetch("/login", {
        method: "POST",
        body: formData
    });

    const data = await res.json();

    if (data.status === "ok") {
        alert("–ê–¥–º—ñ–Ω —É–≤—ñ–π—à–æ–≤ ‚úÖ");
        location.reload();
    } else {
        alert("–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å ‚ùå");
    }
}

async function logout() {
    await fetch("/logout");
    alert("–í–∏ –≤–∏–π—à–ª–∏");
    location.reload();
}
</script>
<script>
async function login() {
    const password = document.getElementById("adminPassword").value;

    const formData = new FormData();
    formData.append("password", password);

    const res = await fetch("/login", {
        method: "POST",
        body: formData,
        credentials: "include"   // ‚≠ê –°–£–ü–ï–† –í–ê–ñ–õ–ò–í–û
    });

    const data = await res.json();

    if (data.status === "ok") {
        alert("–£—Å–ø—ñ—à–Ω–∏–π –≤—Ö—ñ–¥ –≤ –∞–¥–º—ñ–Ω–∫—É ‚úÖ");
        window.location.href = "/admin";  // –æ–¥—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –≤ –∞–¥–º—ñ–Ω–∫—É
    } else {
        alert("–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å ‚ùå");
    }
}

async function logout() {
    await fetch("/logout", {
        credentials: "include"   // ‚≠ê —Ç–µ–∂ –æ–±–æ–≤ º—è–∑–∫–æ–≤–æ
    });

    alert("–í–∏ –≤–∏–π—à–ª–∏ –∑ –∞–¥–º—ñ–Ω–∫–∏");
}
</script>

<div id="timeSlots"></div>
<input type="hidden" id="selectedTime">

<button onclick="createBooking()">–ó–∞–ø–∏—Å–∞—Ç–∏—Å—å</button>

<!-- ‚¨á‚¨á‚¨á –°–ö–†–ò–ü–¢ –í –°–ê–ú–û–ú–£ –ù–ò–ó–£ –°–¢–û–†–Ü–ù–ö–ò -->
<script>
window.addEventListener("DOMContentLoaded", () => {
    const dateInput = document.getElementById("date");
    if(dateInput){
        dateInput.addEventListener("change", loadTimes);
    }
});

async function loadTimes(){
    const date = document.getElementById("date").value;
    if(!date) return;

    const res = await fetch(`/available-times?date=${date}`);
    const times = await res.json();

    const container = document.getElementById("timeSlots");
    container.innerHTML = "";

    times.forEach(t=>{
        const div = document.createElement("div");
        div.className = "time-slot";
        div.innerText = t;
        div.onclick = () => selectTime(t, div);
        container.appendChild(div);
    });
}

function selectTime(time, el){
    document.querySelectorAll(".time-slot")
        .forEach(x=>x.classList.remove("selected"));

    el.classList.add("selected");
    document.getElementById("selectedTime").value = time;
}
</script>
</body>
</html>
